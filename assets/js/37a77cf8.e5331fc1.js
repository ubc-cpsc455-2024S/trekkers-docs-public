"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9805],{517:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>d});var s=i(4848),t=i(8453);const r={slug:"s3-integration",title:"Trek's File Storage System with Amazon S3",authors:["jacob","matthew"],tags:["project","maps","POI","GIS","geocoding","routing"]},o=void 0,a={permalink:"/trekkers-docs-public/blog/s3-integration",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2024-07-20.md",source:"@site/blog/2024-07-20.md",title:"Trek's File Storage System with Amazon S3",description:"This blogpost is a modified version of an internal Trek document. You can view the internal document",date:"2024-07-20T00:00:00.000Z",tags:[{label:"project",permalink:"/trekkers-docs-public/blog/tags/project"},{label:"maps",permalink:"/trekkers-docs-public/blog/tags/maps"},{label:"POI",permalink:"/trekkers-docs-public/blog/tags/poi"},{label:"GIS",permalink:"/trekkers-docs-public/blog/tags/gis"},{label:"geocoding",permalink:"/trekkers-docs-public/blog/tags/geocoding"},{label:"routing",permalink:"/trekkers-docs-public/blog/tags/routing"}],readingTime:3.21,hasTruncateMarker:!1,authors:[{name:"Jacob Zhu",title:"Developer",url:"https://www.linkedin.com/in/jacob-zhu-a70512212",imageURL:"/trekkers-docs-public/img/jacob.jpg",key:"jacob"},{name:"Matthew Kang",title:"Developer",url:"https://www.linkedin.com/in/kang-matt/",imageURL:"/trekkers-docs-public/img/matthewkang.jpeg",key:"matthew"}],frontMatter:{slug:"s3-integration",title:"Trek's File Storage System with Amazon S3",authors:["jacob","matthew"],tags:["project","maps","POI","GIS","geocoding","routing"]},unlisted:!1,nextItem:{title:"Choosing the Best Geographic Information System (GIS) for Trek",permalink:"/trekkers-docs-public/blog/trek-gis-study"}},l={authorsImageUrls:[void 0,void 0]},d=[{value:"Why AWS S3?",id:"why-aws-s3",level:2},{value:"Setting Up AWS Access",id:"setting-up-aws-access",level:2},{value:"MongoDB Schema for S3 Files",id:"mongodb-schema-for-s3-files",level:2},{value:"Backend Validation Before Upload",id:"backend-validation-before-upload",level:3},{value:"Middleware for S3 &amp; MongoDB",id:"middleware-for-s3--mongodb",level:3},{value:"Conclusion",id:"conclusion",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["This blogpost is a modified version of an internal Trek document. You can view the internal document\n",(0,s.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:i(4494).A+"",children:"here"}),"."]})}),"\n",(0,s.jsx)(n.p,{children:"At Trek, our goal is to make trip planning as smooth and efficient as possible. To achieve this, we decided to integrate AWS S3 for storing images and files, allowing users to upload photos and other media easily. In this blog post, we\u2019ll walk you through our integration process, the challenges we faced, and how we overcame them."}),"\n",(0,s.jsx)(n.h2,{id:"why-aws-s3",children:"Why AWS S3?"}),"\n",(0,s.jsx)(n.p,{children:"AWS S3 (Simple Storage Service) provides scalable object storage, making it an ideal choice for our needs. It offers:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Reliable and durable storage."}),"\n",(0,s.jsx)(n.li,{children:"Scalability to handle large amounts of data."}),"\n",(0,s.jsx)(n.li,{children:"Integration with other AWS services."}),"\n",(0,s.jsx)(n.li,{children:"Secure access control and management."}),"\n",(0,s.jsx)(n.li,{children:"Overview of the Integration"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The integration of AWS S3 in Trek is handled entirely by our backend Express server to ensure security and simplicity. Here\u2019s a high-level overview of the data flow when a user uploads an image:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"User Uploads Image: The user uploads an image through the frontend."}),"\n",(0,s.jsx)(n.li,{children:"Backend Processing: The image is sent to the backend server, which handles the upload to S3."}),"\n",(0,s.jsx)(n.li,{children:"S3 Storage: The image is stored in an S3 bucket."}),"\n",(0,s.jsx)(n.li,{children:"MongoDB Logging: Metadata about the uploaded image is logged in our MongoDB database."}),"\n",(0,s.jsx)(n.li,{children:"S3 Pricing Considerations"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"While AWS offers a Free Tier with the following limits:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"5GB of S3 storage."}),"\n",(0,s.jsx)(n.li,{children:"20,000 GET requests."}),"\n",(0,s.jsx)(n.li,{children:"2,000 PUT, COPY, POST, or LIST requests."}),"\n",(0,s.jsx)(n.li,{children:"100GB of data transfer out per month."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"It\u2019s essential to monitor usage to avoid unexpected costs. We learned the hard way when a private, empty S3 bucket unexpectedly incurred a $1300 charge. Always monitor your S3 usage and set budget alerts to avoid surprises."}),"\n",(0,s.jsx)(n.h2,{id:"setting-up-aws-access",children:"Setting Up AWS Access"}),"\n",(0,s.jsx)(n.p,{children:"To interact with AWS S3, we use an IAM user, trek-s3-user, which has the necessary permissions to upload files. The credentials are stored in environment variables for security:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'ATLAS_URI="..."\nAWS_ACCESS_KEY_ID=your_access_key_id\nAWS_SECRET_ACCESS_KEY=your_secret_access_key\nAWS_REGION=us-east-2\nS3_BUCKET_NAME=cpsc-455-trek\n'})}),"\n",(0,s.jsx)(n.p,{children:"These keys are used by our backend server to authenticate requests to AWS S3."}),"\n",(0,s.jsx)(n.h2,{id:"mongodb-schema-for-s3-files",children:"MongoDB Schema for S3 Files"}),"\n",(0,s.jsx)(n.p,{children:"We keep track of the files stored in S3 using a MongoDB collection called S3Files. Here\u2019s the schema:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"_id: Auto-generated unique ID."}),"\n",(0,s.jsx)(n.li,{children:"key: S3 object key."}),"\n",(0,s.jsx)(n.li,{children:"bucket: S3 bucket name."}),"\n",(0,s.jsx)(n.li,{children:"url: URL of the stored object."}),"\n",(0,s.jsx)(n.li,{children:"upload_by: User ID of the uploader."}),"\n",(0,s.jsx)(n.li,{children:"upload_time: Timestamp of the upload."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"backend-validation-before-upload",children:"Backend Validation Before Upload"}),"\n",(0,s.jsx)(n.p,{children:"To ensure that only appropriate files are uploaded, we perform several validations on the backend:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"File Type: Verify the file type being uploaded."}),"\n",(0,s.jsx)(n.li,{children:"File Size: Check if the file size is within acceptable limits."}),"\n",(0,s.jsx)(n.li,{children:"Upload Frequency: Limit the number of files a user can upload within a specific period."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"middleware-for-s3--mongodb",children:"Middleware for S3 & MongoDB"}),"\n",(0,s.jsx)(n.p,{children:"Our backend uses Express middlewares to handle the upload and logging process:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Auth0 Middleware"}),": Verifies the JWT token and appends user information to the request."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"S3 Middleware"}),": Uploads the image to S3 and appends the metadata to the request."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Here\u2019s an example of the S3 uploading middleware:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"import { upload } from './s3/upload';\n\napp.post('/test/upload', upload.array('photos', 3), function (err, req, res) {\n    if (err) {\n        // handle upload error\n    }\n    res.send('Successfully uploaded ' + (req.files?.length ?? 0) + ' files!');\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:"If an error occurs during the upload, it\u2019s passed to the callback function, allowing for proper error handling."}),"\n",(0,s.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,s.jsx)(n.p,{children:"Integrating AWS S3 into Trek has enhanced our ability to handle user-uploaded images efficiently and securely. By leveraging AWS S3\u2019s scalable storage and integrating it with our backend, we\u2019ve ensured that our users have a seamless experience when planning their trips. We hope our journey and insights help you in your own integration projects."}),"\n",(0,s.jsx)(n.p,{children:"Stay tuned for more updates and technical deep dives from the Trekkers team!"})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},4494:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/files/Trek-AWS-S3-Integration-f7a9135df2cc329b75883ab8cb6a6c7d.pdf"},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>a});var s=i(6540);const t={},r=s.createContext(t);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);